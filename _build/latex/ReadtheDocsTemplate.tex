%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
 \ifdefined\DeclareUnicodeCharacterAsOptional
  \DeclareUnicodeCharacter{"00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{"2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{"2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{"2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{"251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{"2572}{\textbackslash}
 \else
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{2572}{\textbackslash}
 \fi
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.}}
\addto\captionsenglish{\renewcommand{\tablename}{Table}}
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}


\title{Singularity Container Documentation}
\date{Nov 08, 2018}
\release{3.0}
\author{User Docs}
\newcommand{\sphinxlogo}{\sphinxincludegraphics{logo.png}\par}
\renewcommand{\releasename}{Release}
\makeindex

\begin{document}

\maketitle
\sphinxtableofcontents
\phantomsection\label{\detokenize{index::doc}}



\chapter{Quick Start}
\label{\detokenize{quick_start:quick-start}}\label{\detokenize{quick_start:id1}}\label{\detokenize{quick_start::doc}}\phantomsection\label{\detokenize{quick_start:sec-quickstart}}
This guide is intended for running Singularity on a computer where you
have root (administrative) privileges.

If you need to request an installation on your shared resource, see the
\DUrole{xref,std,std-ref}{requesting an installation help page} for
information to send to your system administrator.

For any additional help or support contact the Sylabs team:
\sphinxurl{https://www.sylabs.io/contact/}


\section{Quick Installation Steps}
\label{\detokenize{quick_start:quick-installation-steps}}\label{\detokenize{quick_start:quick-installation}}
You will need a Linux system to run Singularity.

See the \DUrole{xref,std,std-ref}{installation page} for information about installing
older versions of Singularity.


\subsection{Install system dependencies}
\label{\detokenize{quick_start:install-system-dependencies}}
You must first install development libraries to your host. Assuming Ubuntu
(apply similar to RHEL derivatives):

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo apt\PYGZhy{}get update \PYGZam{}\PYGZam{} sudo apt\PYGZhy{}get install \PYGZhy{}y \PYGZbs{}
    build\PYGZhy{}essential \PYGZbs{}
    libssl\PYGZhy{}dev \PYGZbs{}
    uuid\PYGZhy{}dev \PYGZbs{}
    libgpgme11\PYGZhy{}dev
\end{sphinxVerbatim}


\subsection{Install Go}
\label{\detokenize{quick_start:install-go}}
Singularity 3.0 is written primarily in Go, and you will need Go installed to
compile it from source.

This is one of several ways to \sphinxhref{https://golang.org/doc/install}{install and configure Go}.

First, visit the \sphinxhref{https://golang.org/dl/}{Go download page} and pick the
appropriate Go archive (\textgreater{}=1.11.1). Copy the link address and download
with \sphinxcode{\sphinxupquote{wget}} like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} export VERSION=1.11 OS=linux ARCH=amd64
\PYGZdl{} cd /tmp
\PYGZdl{} wget https://dl.google.com/go/go\PYGZdl{}VERSION.\PYGZdl{}OS\PYGZhy{}\PYGZdl{}ARCH.tar.gz
\end{sphinxVerbatim}

Then extract the archive to \sphinxcode{\sphinxupquote{/usr/local}}

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo tar \PYGZhy{}C /usr/local \PYGZhy{}xzf go\PYGZdl{}VERSION.\PYGZdl{}OS\PYGZhy{}\PYGZdl{}ARCH.tar.gz
\end{sphinxVerbatim}

Finally, set up your environment for Go

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} echo \PYGZsq{}export GOPATH=\PYGZdl{}\PYGZob{}HOME\PYGZcb{}/go\PYGZsq{} \PYGZgt{}\PYGZgt{} \PYGZti{}/.bashrc
\PYGZdl{} echo \PYGZsq{}export PATH=/usr/local/go/bin:\PYGZdl{}\PYGZob{}PATH\PYGZcb{}:\PYGZdl{}\PYGZob{}GOPATH\PYGZcb{}/bin\PYGZsq{} \PYGZgt{}\PYGZgt{} \PYGZti{}/.bashrc
\PYGZdl{} source \PYGZti{}/.bashrc
\end{sphinxVerbatim}


\subsection{Clone the Singularity repository}
\label{\detokenize{quick_start:clone-the-singularity-repository}}
Go is a bit finicky about where things are placed. Here is the correct way to
build Singularity from source.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZhy{}p \PYGZdl{}GOPATH/src/github.com/sylabs
\PYGZdl{} cd \PYGZdl{}GOPATH/src/github.com/sylabs
\PYGZdl{} git clone https://github.com/sylabs/singularity.git
\PYGZdl{} cd singularity
\end{sphinxVerbatim}


\subsection{Install Go dependencies}
\label{\detokenize{quick_start:install-go-dependencies}}
Dependencies are managed using \sphinxhref{https://github.com/golang/dep}{Dep}. You
can use go get to install it like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} go get \PYGZhy{}u \PYGZhy{}v github.com/golang/dep/cmd/dep
\end{sphinxVerbatim}


\subsection{Compile the Singularity binary}
\label{\detokenize{quick_start:compile-the-singularity-binary}}
Now you are ready to build Singularity. Dependencies will be automatically
downloaded. You can build Singularity using the following commands:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}GOPATH/src/github.com/sylabs/singularity
\PYGZdl{} ./mconfig
\PYGZdl{} make \PYGZhy{}C builddir
\PYGZdl{} sudo make \PYGZhy{}C builddir install
\end{sphinxVerbatim}

Singularity must be installed as root to function properly.


\section{Overview of the Singularity Interface}
\label{\detokenize{quick_start:overview-of-the-singularity-interface}}
Singularity’s \DUrole{xref,std,std-ref}{command line interface} allows you to build
and interact with containers transparently. You can run programs inside a
container as if they were running on your host system. You can easily redirect
IO, use pipes, pass arguments, and access files, sockets, and ports on the host
system from within a container.

The \sphinxcode{\sphinxupquote{help}} command gives an overview of Singularity options and subcommands as
follows:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity help

Linux container platform optimized for High Performance Computing (HPC) and
Enterprise Performance Computing (EPC)

Usage:
  singularity [global options...]

Description:
  Singularity containers provide an application virtualization layer enabling
  mobility of compute via both application and environment portability. With
  Singularity one is capable of building a root file system that runs on any
  other Linux system where Singularity is installed.

Options:
  \PYGZhy{}d, \PYGZhy{}\PYGZhy{}debug              print debugging information (highest verbosity)
  \PYGZhy{}h, \PYGZhy{}\PYGZhy{}help               help for singularity
  \PYGZhy{}q, \PYGZhy{}\PYGZhy{}quiet              suppress normal output
  \PYGZhy{}s, \PYGZhy{}\PYGZhy{}silent             only print errors
  \PYGZhy{}t, \PYGZhy{}\PYGZhy{}tokenfile string   path to the file holding your sylabs
                           authentication token (default
                           \PYGZdq{}/home/david/.singularity/sylabs\PYGZhy{}token\PYGZdq{})
  \PYGZhy{}v, \PYGZhy{}\PYGZhy{}verbose            print additional information

Available Commands:
  build       Build a new Singularity container
  capability  Manage Linux capabilities on containers
  exec        Execute a command within container
  help        Help about any command
  inspect     Display metadata for container if available
  instance    Manage containers running in the background
  keys        Manage OpenPGP key stores
  pull        Pull a container from a URI
  push        Push a container to a Library URI
  run         Launch a runscript within container
  run\PYGZhy{}help    Display help for container if available
  search      Search the library
  shell       Run a Bourne shell within container
  sign        Attach cryptographic signatures to container
  test        Run defined tests for this particular container
  verify      Verify cryptographic signatures on container
  version     Show application version

Examples:
  \PYGZdl{} singularity help \PYGZlt{}command\PYGZgt{}
      Additional help for any Singularity subcommand can be seen by appending
      the subcommand name to the above command.


For additional help or support, please visit https://www.sylabs.io/docs/
\end{sphinxVerbatim}

Information about subcommand can also be viewed with the \sphinxcode{\sphinxupquote{help}} command.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity help verify
Verify cryptographic signatures on container

Usage:
  singularity verify [verify options...] \PYGZlt{}image path\PYGZgt{}

Description:
  The verify command allows a user to verify cryptographic signatures on SIF
  container files. There may be multiple signatures for data objects and
  multiple data objects signed. By default the command searches for the primary
  partition signature. If found, a list of all verification blocks applied on
  the primary partition is gathered so that data integrity (hashing) and
  signature verification is done for all those blocks.

Options:
  \PYGZhy{}g, \PYGZhy{}\PYGZhy{}groupid uint32   group ID to be verified
  \PYGZhy{}h, \PYGZhy{}\PYGZhy{}help             help for verify
  \PYGZhy{}i, \PYGZhy{}\PYGZhy{}id uint32        descriptor ID to be verified
  \PYGZhy{}u, \PYGZhy{}\PYGZhy{}url string       key server URL (default \PYGZdq{}https://keys.sylabs.io\PYGZdq{})


Examples:
  \PYGZdl{} singularity verify container.sif


For additional help or support, please visit https://www.sylabs.io/docs/
\end{sphinxVerbatim}

Singularity uses positional syntax (i.e. the order of commands and options
matters).

Global options affecting the behavior of all commands follow the main
\sphinxcode{\sphinxupquote{singularity}} command. Then sub commands are passed followed by their options
and arguments.

For example, to pass the \sphinxcode{\sphinxupquote{-{-}debug}} option to the main \sphinxcode{\sphinxupquote{singularity}} command
and run Singularity with debugging messages on:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity \PYGZhy{}\PYGZhy{}debug run library://sylabsed/examples/lolcow
\end{sphinxVerbatim}

To pass the \sphinxcode{\sphinxupquote{-{-}containall}} option to the \sphinxcode{\sphinxupquote{run}} command and run a
Singularity image in an isolated manner:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity run \PYGZhy{}\PYGZhy{}containall library://sylabsed/examples/lolcow
\end{sphinxVerbatim}

Singularity 2.4 introduced the concept of command groups. For instance, to list
Linux capabilities for a particular user, you would use the  \sphinxcode{\sphinxupquote{list}} command in
the \sphinxcode{\sphinxupquote{capabilities}} command group like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity capability list \PYGZhy{}\PYGZhy{}user dave
\end{sphinxVerbatim}

Container authors might also \DUrole{xref,std,std-ref}{write help docs specific to a container}
or for an internal module called an \sphinxcode{\sphinxupquote{app}}. If those help docs exist for a
particular container, you can view them like so.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity help container.sif  \PYGZsh{} See the container\PYGZsq{}s help, if provided

\PYGZdl{} singularity help \PYGZhy{}\PYGZhy{}app foo container.sif  \PYGZsh{} See the help for foo, if provided
\end{sphinxVerbatim}


\section{Download pre-built images}
\label{\detokenize{quick_start:download-pre-built-images}}
You can use the \sphinxcode{\sphinxupquote{search}} command to locate groups, collections, and
containers of interest on the \sphinxhref{https://cloud.sylabs.io/library}{Container Library} .

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity search alp
No users found for \PYGZsq{}alp\PYGZsq{}

Found 1 collections for \PYGZsq{}alp\PYGZsq{}
    library://jchavez/alpine

Found 5 containers for \PYGZsq{}alp\PYGZsq{}
    library://jialipassion/official/alpine
            Tags: latest
    library://dtrudg/linux/alpine
            Tags: 3.2 3.3 3.4 3.5 3.6 3.7 3.8 edge latest
    library://sylabsed/linux/alpine
            Tags: 3.6 3.7 latest
    library://library/default/alpine
            Tags: 3.1 3.2 3.3 3.4 3.5 3.6 3.7 3.8 latest
    library://sylabsed/examples/alpine
            Tags: latest
\end{sphinxVerbatim}

You can use the \DUrole{xref,std,std-ref}{pull} and \DUrole{xref,std,std-ref}{build}
commands to download pre-built images from an external resource like the
\sphinxhref{https://cloud.sylabs.io/library}{Container Library} or
\sphinxhref{https://hub.docker.com/}{Docker Hub}.

When called on a native Singularity image like those provided on the Container
Library, \sphinxcode{\sphinxupquote{pull}} simply downloads the image file to your system.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity pull library://sylabsed/linux/alpine
\end{sphinxVerbatim}

You can also use \sphinxcode{\sphinxupquote{pull}} with the \sphinxcode{\sphinxupquote{docker://}} uri to reference Docker images
served from a registry. In this case \sphinxcode{\sphinxupquote{pull}} does not just download an image
file. Docker images are stored in layers, so \sphinxcode{\sphinxupquote{pull}} must also combine those
layers into a usable Singularity file.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity pull docker://godlovedc/lolcow
\end{sphinxVerbatim}

Pulling Docker images reduces reproducibility. If you were to pull a Docker
image today and then wait six months and pull again, you are not guaranteed to
get the same image. If any of the source layers has changed the image will be
altered. If reproducibility is a priority for you, try building your images from
the Container Library.

You can also use the \sphinxcode{\sphinxupquote{build}} command to download pre-built images from an
external resource. When using \sphinxcode{\sphinxupquote{build}} you must specify a name for your
container like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity build ubuntu.sif library://ubuntu

\PYGZdl{} singularity build lolcow.sif docker://godlovedc/lolcow
\end{sphinxVerbatim}

Unlike \sphinxcode{\sphinxupquote{pull}}, \sphinxcode{\sphinxupquote{build}} will convert your image to the latest Singularity
image format after downloading it.

\sphinxcode{\sphinxupquote{build}} is like a “Swiss Army knife” for container creation. In addition to
downloading images, you can use \sphinxcode{\sphinxupquote{build}} to create images from other images or
from scratch using a \DUrole{xref,std,std-ref}{definition file}. You can also
use \sphinxcode{\sphinxupquote{build}} to convert an image between the container formats supported by
Singularity.


\section{Interact with images}
\label{\detokenize{quick_start:interact-with-images}}
You can interact with images in several ways. It is not actually necessary to
\sphinxcode{\sphinxupquote{pull}} or \sphinxcode{\sphinxupquote{build}} an image to interact with it. The commands listed here
will work with image URIs in addition to accepting a local  path to an image.

For these examples we will use a \sphinxcode{\sphinxupquote{lolcow\_latest.sif}} image that can be pulled
from the Container Library like so.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity pull library://sylabsed/examples/lolcow
\end{sphinxVerbatim}


\subsection{Shell}
\label{\detokenize{quick_start:shell}}
The \DUrole{xref,std,std-ref}{shell} command allows you to spawn a new shell within
your container and interact with it as though it were a small virtual machine.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity shell lolcow\PYGZus{}latest.sif

Singularity lolcow\PYGZus{}latest.sif:\PYGZti{}\PYGZgt{}
\end{sphinxVerbatim}

The change in prompt indicates that you have entered the container (though you
should not rely on that to determine whether you are in container or not).

Once inside of a Singularity container, you are the same user as you are on the
host system.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Singularity lolcow\PYGZus{}latest.sif:\PYGZti{}\PYGZgt{} whoami
david

Singularity lolcow\PYGZus{}latest.sif:\PYGZti{}\PYGZgt{} id
uid=1000(david) gid=1000(david) groups=1000(david),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{shell}} also works with the \sphinxcode{\sphinxupquote{library://}}, \sphinxcode{\sphinxupquote{docker://}}, and \sphinxcode{\sphinxupquote{shub://}}
URIs. This creates an ephemeral container that disappears when the shell is
exited.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity shell library://sylabsed/examples/lolcow
\end{sphinxVerbatim}


\subsection{Executing Commands}
\label{\detokenize{quick_start:executing-commands}}
The \DUrole{xref,std,std-ref}{exec} command allows you to execute a custom command
within a container by specifying the image file. For instance, to execute the
\sphinxcode{\sphinxupquote{cowsay}} program within the \sphinxcode{\sphinxupquote{lolcow\_latest.sif}} container:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity exec lolcow\PYGZus{}latest.sif cowsay moo
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
\PYGZlt{} moo \PYGZgt{}
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{exec}} also works with the \sphinxcode{\sphinxupquote{library://}}, \sphinxcode{\sphinxupquote{docker://}}, and \sphinxcode{\sphinxupquote{shub://}}
URIs. This creates an ephemeral container that executes a command and
disappears.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity exec library://sylabsed/examples/lolcow cowsay \PYGZdq{}Fresh from the library!\PYGZdq{}
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
\PYGZlt{} Fresh from the library! \PYGZgt{}
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}
\end{sphinxVerbatim}


\subsection{Running a container}
\label{\detokenize{quick_start:running-a-container}}
Singularity containers contain \DUrole{xref,std,std-ref}{runscripts}. These are user
defined scripts that define the actions a container should perform when someone
runs it. The runscript can be triggered with the \DUrole{xref,std,std-ref}{run}
command, or simply by  calling the container as though it were an executable.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity run lolcow\PYGZus{}latest.sif
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
/ You have been selected for a secret \PYGZbs{}
\PYGZbs{} mission.                            /
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}

\PYGZdl{} ./lolcow\PYGZus{}latest.sif
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
/ Q: What is orange and goes \PYGZdq{}click, \PYGZbs{}
\PYGZbs{} click?\PYGZdq{} A: A ball point carrot.    /
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{run}} also works with the \sphinxcode{\sphinxupquote{library://}}, \sphinxcode{\sphinxupquote{docker://}}, and \sphinxcode{\sphinxupquote{shub://}} URIs.
This creates an ephemeral container that runs and then disappears.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity run library://sylabsed/examples/lolcow
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
/ Is that really YOU that is reading \PYGZbs{}
\PYGZbs{} this?                              /
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}
\end{sphinxVerbatim}


\subsection{Working with Files}
\label{\detokenize{quick_start:working-with-files}}
Files on the host are reachable from within the container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} echo \PYGZdq{}Hello from inside the container\PYGZdq{} \PYGZgt{} \PYGZdl{}HOME/hostfile.txt

\PYGZdl{} singularity exec lolcow\PYGZus{}latest.sif cat \PYGZdl{}HOME/hostfile.txt

Hello from inside the container
\end{sphinxVerbatim}

This example works because \sphinxcode{\sphinxupquote{hostfile.txt}} exists in the user’s home directory.
By default Singularity bind mounts \sphinxcode{\sphinxupquote{/home/\$USER}}, \sphinxcode{\sphinxupquote{/tmp}}, and \sphinxcode{\sphinxupquote{\$PWD}} into
your container at runtime.

You can specify additional directories to bind mount into your container with
the \sphinxcode{\sphinxupquote{-{-}bind}} option. In this example, the \sphinxcode{\sphinxupquote{data}}
directory on the host system is bind mounted to the \sphinxcode{\sphinxupquote{/mnt}} directory inside
the container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} echo \PYGZdq{}Drink milk (and never eat hamburgers).\PYGZdq{} \PYGZgt{} /data/cow\PYGZus{}advice.txt

\PYGZdl{} singularity exec \PYGZhy{}\PYGZhy{}bind /data:/mnt lolcow\PYGZus{}latest.sif cat /mnt/cow\PYGZus{}advice.txt
Drink milk (and never eat hamburgers).
\end{sphinxVerbatim}

Pipes and redirects also work with Singularity commands just like they do with
normal Linux commands.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cat /data/cow\PYGZus{}advice.txt \textbar{} singularity exec lolcow\PYGZus{}latest.sif cowsay
 \PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
\PYGZlt{} Drink milk (and never eat hamburgers). \PYGZgt{}
 \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
        \PYGZbs{}   \PYGZca{}\PYGZus{}\PYGZus{}\PYGZca{}
         \PYGZbs{}  (oo)\PYGZbs{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
            (\PYGZus{}\PYGZus{})\PYGZbs{}       )\PYGZbs{}/\PYGZbs{}
                \textbar{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}w \textbar{}
                \textbar{}\textbar{}     \textbar{}\textbar{}
\end{sphinxVerbatim}


\section{Build images from scratch}
\label{\detokenize{quick_start:build-images-from-scratch}}\label{\detokenize{quick_start:id3}}\phantomsection\label{\detokenize{quick_start:sec-buildimagesfromscratch}}
Singularity v3.0 produces immutable images in the Singularity Image File (SIF)
format. This ensures reproducible and verifiable images and allows for many
extra benefits such as the ability to sign and verify your containers.

However, during testing and debugging you may want an image format that is
writable. This way you can \sphinxcode{\sphinxupquote{shell}} into the image and install software and
dependencies until you are satisfied that your container will fulfill your
needs. For these scenarios, Singularity also supports the \sphinxcode{\sphinxupquote{sandbox}} format
(which is really just a directory).

For more details about the different build options and best practices,
read about the \DUrole{xref,std,std-ref}{Singularity flow}.


\subsection{Sandbox Directories}
\label{\detokenize{quick_start:sandbox-directories}}
To build into a \sphinxcode{\sphinxupquote{sandbox}} (container in a directory) use the
\sphinxcode{\sphinxupquote{build -{-}sandbox}} command and option:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build \PYGZhy{}\PYGZhy{}sandbox ubuntu/ library://ubuntu
\end{sphinxVerbatim}

This command creates a directory called \sphinxcode{\sphinxupquote{ubuntu/}} with an entire Ubuntu
Operating System and some Singularity metadata in your current working
directory.

You can use commands like \sphinxcode{\sphinxupquote{shell}}, \sphinxcode{\sphinxupquote{exec}} , and \sphinxcode{\sphinxupquote{run}} with this directory
just as you would with a Singularity image. If you pass the \sphinxcode{\sphinxupquote{-{-}writable}}
option when you use your container you can also write files within the sandbox
directory (provided you have the permissions to do so).

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}writable ubuntu touch /foo

\PYGZdl{} singularity exec ubuntu/ ls /foo
/foo
\end{sphinxVerbatim}


\subsection{Converting images from one format to another}
\label{\detokenize{quick_start:converting-images-from-one-format-to-another}}
The \sphinxcode{\sphinxupquote{build}} command allows you to build a container from an existing
container. This means that you can use it to convert a container from one format
to another. For instance, if you have already created a sandbox (directory) and
want to convert it to the default immutable image format (squashfs) you can do
so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity build new\PYGZhy{}sif sandbox
\end{sphinxVerbatim}

Doing so may break reproducibility if you have altered your sandbox outside of
the context of a definition file, so you are advised to exercise care.


\subsection{Singularity Definition Files}
\label{\detokenize{quick_start:singularity-definition-files}}
For a reproducible, production-quality container you should build a SIF file
using a Singularity definition file. This also makes it easy to add files,
environment variables, and install custom software, and still start from your
base of choice (e.g., the Container Library).

A definition file has a header and a body. The header determines the base
container to begin with, and the body is further divided into sections that do
things like install software, setup the environment, and copy files into the
container from the host system.

Here is an example of a definition file:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
BootStrap: library
From: ubuntu:16.04

\PYGZpc{}post
    apt\PYGZhy{}get \PYGZhy{}y update
    apt\PYGZhy{}get \PYGZhy{}y install fortune cowsay lolcat

\PYGZpc{}environment
    export LC\PYGZus{}ALL=C
    export PATH=/usr/games:\PYGZdl{}PATH

\PYGZpc{}runscript
    fortune \textbar{} cowsay \textbar{} lolcat

\PYGZpc{}labels
    Author GodloveD
\end{sphinxVerbatim}

To build a container from this definition file (assuming it is a file
named lolcow.def), you would call build like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build lolcow.sif lolcow.def
\end{sphinxVerbatim}

In this example, the header tells Singularity to use a base Ubuntu 16.04 image
from the Container Library.

The \sphinxcode{\sphinxupquote{\%post}} section executes within the container at build time after the base
OS has been installed. The \sphinxcode{\sphinxupquote{\%post}} section is therefore the place to perform
installations of new applications.

The \sphinxcode{\sphinxupquote{\%environment}} section defines some environment variables that will be
available to the container at runtime.

The \sphinxcode{\sphinxupquote{\%runscript}} section defines actions for the container to take when it is
executed.

And finally, the \sphinxcode{\sphinxupquote{\%labels}} section allows for custom metadata to be added to
the container.

This is a very small example of the things that you can do with a \DUrole{xref,std,std-ref}{definition file}.
In addition to building a container from the Container Library, you can start
with base images from Docker Hub and use images directly from official
repositories such as Ubuntu, Debian, CentOS, Arch, and BusyBox.  You can also
use an existing container on your host system as a base.

If you want to build Singularity images but you don’t have administrative (root)
access on your build system, you can build images using the \sphinxhref{https://cloud.sylabs.io/builder}{Remote Builder}.

This quickstart document just scratches the surface of all of the things you can
do with Singularity!

If you need additional help or support, contact the Sylabs team:
\sphinxurl{https://www.sylabs.io/contact/}


\chapter{Build a Container}
\label{\detokenize{build_a_container:build-a-container}}\label{\detokenize{build_a_container:id1}}\label{\detokenize{build_a_container::doc}}\phantomsection\label{\detokenize{build_a_container:sec-build-a-container}}
\sphinxcode{\sphinxupquote{build}} is the “Swiss army knife” of container creation. You can use it to
download and assemble existing containers from external resources like the
\sphinxhref{https://cloud.sylabs.io/library}{Container Library} and
\sphinxhref{https://hub.docker.com/}{Docker Hub}. You can use it to convert containers
between the formats supported by Singularity. And you can use it in conjunction
with a \DUrole{xref,std,std-ref}{Singularity definition} file to create a
container from scratch and customized it to fit your needs.


\section{Overview}
\label{\detokenize{build_a_container:overview}}
The \sphinxcode{\sphinxupquote{build}} command accepts a target as input and produces a container as
output.

The target defines the method that \sphinxcode{\sphinxupquote{build}} uses to create the container. It
can be one of the following:
\begin{itemize}
\item {} 
URI beginning with \sphinxstylestrong{library://} to build from the Container Library

\item {} 
URI beginning with \sphinxstylestrong{docker://} to build from Docker Hub

\item {} 
URI beginning with \sphinxstylestrong{shub://} to build from Singularity Hub

\item {} 
path to a \sphinxstylestrong{existing container} on your local machine

\item {} 
path to a \sphinxstylestrong{directory} to build from a sandbox

\item {} 
path to a \DUrole{xref,std,std-ref}{Singularity definition file}

\end{itemize}

\sphinxcode{\sphinxupquote{build}} can produce containers in two different formats that can be specified
as follows.
\begin{itemize}
\item {} 
compressed read-only \sphinxstylestrong{Singularity Image File (SIF)} format suitable for
production (default)

\item {} 
writable \sphinxstylestrong{(ch)root directory} called a sandbox for interactive development
( \sphinxcode{\sphinxupquote{-{-}sandbox}} option)

\end{itemize}

Because \sphinxcode{\sphinxupquote{build}} can accept an existing container as a target and create a
container in either supported format you can convert existing containers from
one format to another.


\section{Downloading an existing container from the Container Library}
\label{\detokenize{build_a_container:downloading-an-existing-container-from-the-container-library}}
You can use the build command to download a container from the Container
Library.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build lolcow.simg library://sylabs\PYGZhy{}jms/testing/lolcow
\end{sphinxVerbatim}

The first argument (\sphinxcode{\sphinxupquote{lolcow.simg}}) specifies a path and name for your
container. The second argument (\sphinxcode{\sphinxupquote{library://sylabs-jms/testing/lolcow}}) gives
the Container Library URI from which to download. By default the container will
be converted to a compressed, read-only SIF. If you want your container in a
writable format use the \sphinxcode{\sphinxupquote{-{-}sandbox}} option.


\section{Downloading an existing container from Docker Hub}
\label{\detokenize{build_a_container:downloading-an-existing-container-from-docker-hub}}
You can use \sphinxcode{\sphinxupquote{build}} to download layers from Docker Hub and assemble them into
Singularity containers.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build lolcow.sif docker://godlovedc/lolcow
\end{sphinxVerbatim}


\section{Creating writable \sphinxstyleliteralintitle{\sphinxupquote{-{-}sandbox}} directories}
\label{\detokenize{build_a_container:creating-writable-sandbox-directories}}
If you wanted to create a container within a writable directory (called a
sandbox) you can do so with the \sphinxcode{\sphinxupquote{-{-}sandbox}} option. It’s possible to create a
sandbox without root privileges, but to ensure proper file permissions it is
recommended to do so as root.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build \PYGZhy{}\PYGZhy{}sandbox lolcow/ library://sylabs\PYGZhy{}jms/testing/lolcow
\end{sphinxVerbatim}

The resulting directory operates just like a container in a SIF file. To make
changes within the container, use the \sphinxcode{\sphinxupquote{-{-}writable}} flag when you invoke your
container.  It’s a good idea to do this as root to ensure you have permission to
access the files and directories that you want to change.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}writable lolcow/
\end{sphinxVerbatim}


\section{Converting containers from one format to another}
\label{\detokenize{build_a_container:converting-containers-from-one-format-to-another}}
If you already have a container saved locally, you can use it as a target to
build a new container. This allows you convert containers from one format to
another. For example if you had a sandbox container called \sphinxcode{\sphinxupquote{development/}} and
you wanted to convert it to SIF container called \sphinxcode{\sphinxupquote{production.sif}} you could:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build production.sif development/
\end{sphinxVerbatim}

Use care when converting a sandbox directory to the default SIF format. If
changes were made to the writable container before conversion, there is no
record of those changes in the Singularity definition file rendering your
container non-reproducible. It is a best practice to build your immutable
production containers directly from a Singularity definition file instead.


\section{Building containers from Singularity definition files}
\label{\detokenize{build_a_container:building-containers-from-singularity-definition-files}}
Of course, Singularity definition files can be used as the target when building
a container. For detailed information on writing Singularity definition files,
please see the \DUrole{xref,std,std-ref}{Container Definition docs}. Let’s say
you already have the following container definition file called \sphinxcode{\sphinxupquote{lolcow.def}},
and you want to use it to build a SIF container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Bootstrap: docker
From: ubuntu:16.04

\PYGZpc{}post
    apt\PYGZhy{}get \PYGZhy{}y update
    apt\PYGZhy{}get \PYGZhy{}y install fortune cowsay lolcat

\PYGZpc{}environment
    export LC\PYGZus{}ALL=C
    export PATH=/usr/games:\PYGZdl{}PATH

\PYGZpc{}runscript
    fortune \textbar{} cowsay \textbar{} lolcat
\end{sphinxVerbatim}

You can do so with the following command.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build lolcow.sif lolcow.def
\end{sphinxVerbatim}

The command requires \sphinxcode{\sphinxupquote{sudo}} just as installing software on your local machine
requires root privileges.


\section{Build options}
\label{\detokenize{build_a_container:build-options}}

\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}builder}}}
\label{\detokenize{build_a_container:builder}}
Singularity 3.0 introduces the option to perform a remote build. The
\sphinxcode{\sphinxupquote{-{-}builder}} option allows you to specify a URL to a different build service.
For instance, you may need to specify a URL to build to an on premises
installation of the remote builder.  This option must be used in conjunction
with \sphinxcode{\sphinxupquote{-{-}remote}}.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}detached}}}
\label{\detokenize{build_a_container:detached}}
When used in combination with the \sphinxcode{\sphinxupquote{-{-}remote}} option, the \sphinxcode{\sphinxupquote{-{-}detached}} option
will detach the build from your terminal and allow it to build in the background
without echoing any output to your terminal.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}force}}}
\label{\detokenize{build_a_container:force}}
The \sphinxcode{\sphinxupquote{-{-}force}} option will delete and overwrite an existing Singularity image
without presenting the normal interactive prompt.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}json}}}
\label{\detokenize{build_a_container:json}}
The \sphinxcode{\sphinxupquote{-{-}json}} option will force Singularity to interpret a given definition
file as a json.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}library}}}
\label{\detokenize{build_a_container:library}}
This command allows you to set a different library.  (The default library is
“\sphinxurl{https://library.sylabs.io}”)


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}notest}}}
\label{\detokenize{build_a_container:notest}}
If you don’t want to run the \sphinxcode{\sphinxupquote{\%test}} section during the container build, you can
skip it with the \sphinxcode{\sphinxupquote{-{-}notest}} option. For instance, maybe you are building a
container intended to run in a production environment with GPUs. But
perhaps your local build resource does not have GPUs. You want to
include a \sphinxcode{\sphinxupquote{\%test}} section that runs a short validation but you don’t want your
build to exit with an error because it cannot find a GPU on your system.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}remote}}}
\label{\detokenize{build_a_container:remote}}
Singularity 3.0 introduces the ability to build a container on an external
resource running a remote builder.  (The default remote builder is located at
“\sphinxurl{https://build.sylabs.io}”.)


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}sandbox}}}
\label{\detokenize{build_a_container:sandbox}}
Build a sandbox (chroot directory) instead of the default SIF format.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}section}}}
\label{\detokenize{build_a_container:section}}
Instead of running the entire definition file, only run a specific section or
sections.  This option accepts a comma delimited string of definition file
sections.  Acceptable arguments include \sphinxcode{\sphinxupquote{all}}, \sphinxcode{\sphinxupquote{none}} or any combination of
the following: \sphinxcode{\sphinxupquote{setup}}, \sphinxcode{\sphinxupquote{post}}, \sphinxcode{\sphinxupquote{files}}, \sphinxcode{\sphinxupquote{environment}}, \sphinxcode{\sphinxupquote{test}},
\sphinxcode{\sphinxupquote{labels}}.

Under normal build conditions, the Singularity definition file is saved into
a container’s meta-data so that there is a record showing how the container was
built. Using the \sphinxcode{\sphinxupquote{-{-}section}} option may render this meta-data useless, so use
care if you value reproducibility.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}update}}}
\label{\detokenize{build_a_container:update}}
You can build into the same sandbox container multiple times (though the results
may be unpredictable and it is generally better to delete your container and
start from scratch).

By default if you build into an existing sandbox container, the  \sphinxcode{\sphinxupquote{build}}
command will prompt you to decide whether or not to overwrite the container.
Instead of this behavior you can use the \sphinxcode{\sphinxupquote{-{-}update}} option to build \_into\_ an
existing container. This will cause Singularity to skip the header and build
any sections that are in the definition file into the existing container.

The \sphinxcode{\sphinxupquote{-{-}update}} option is only valid when used with sandbox containers.


\section{More Build topics}
\label{\detokenize{build_a_container:more-build-topics}}\begin{itemize}
\item {} 
If you want to \sphinxstylestrong{customize the cache location} (where Docker layers are
downloaded on your system), specify Docker credentials, or any custom tweaks
to your build environment, see \DUrole{xref,std,std-ref}{build environment}.

\item {} 
If you want to make internally \sphinxstylestrong{modular containers}, check out the getting
started guide \sphinxhref{https://sci-f.github.io/tutorials}{here}

\item {} 
If you want to \sphinxstylestrong{build your containers} on the Remote Builder, (because you
don’t have root access on a Linux machine or want to host your container on
the cloud) check out \sphinxhref{https://cloud.sylabs.io/builder}{this site}

\end{itemize}


\chapter{Bind Paths and Mounts}
\label{\detokenize{bind_paths_and_mounts:bind-paths-and-mounts}}\label{\detokenize{bind_paths_and_mounts:id1}}\label{\detokenize{bind_paths_and_mounts::doc}}\phantomsection\label{\detokenize{bind_paths_and_mounts:sec-bindpaths}}
If \sphinxhref{https://singularity-admindoc.readthedocs.io/en/latest/the\_singularity\_config\_file.html\#user-bind-control-boolean-default-yes}{enabled by the system administrator},
Singularity allows you to map directories on your host system to directories
within your container using bind mounts. This allows you to read and write data
on the host system with ease.


\section{Overview}
\label{\detokenize{bind_paths_and_mounts:overview}}
When Singularity ‘swaps’ the host operating system for the one inside your
container, the host file systems becomes inaccessible. But you may want to read
and write files on the host system from within the container. To enable this
functionality, Singularity will bind directories back into the container via two
primary methods: system-defined bind paths and user-defined bind paths.


\section{System-defined bind paths}
\label{\detokenize{bind_paths_and_mounts:system-defined-bind-paths}}
The system administrator has the ability to define what bind paths will be
included automatically inside each container. Some bind paths are automatically
derived (e.g. a user’s home directory) and some are statically defined (e.g.
bind paths in the Singularity configuration file). In the default
configuration, the directories \sphinxcode{\sphinxupquote{\$HOME}} , \sphinxcode{\sphinxupquote{/tmp}} , \sphinxcode{\sphinxupquote{/proc}} , \sphinxcode{\sphinxupquote{/sys}} ,
\sphinxcode{\sphinxupquote{/dev}}, and \sphinxcode{\sphinxupquote{\$PWD}} are among the system-defined bind paths.


\section{User-defined bind paths}
\label{\detokenize{bind_paths_and_mounts:user-defined-bind-paths}}
If the system administrator has \sphinxhref{https://singularity-admindoc.readthedocs.io/en/latest/the\_singularity\_config\_file.html\#user-bind-control-boolean-default-yes}{enabled user control of binds},
you will be able to request your own bind paths within your container.

The Singularity action commands (\sphinxcode{\sphinxupquote{run}}, \sphinxcode{\sphinxupquote{exec}} ,{}`{}`shell{}`{}`, and
\sphinxcode{\sphinxupquote{instance start}} will accept the \sphinxcode{\sphinxupquote{-{-}bind/-B}} command-line option to specify
bind paths, and will also honor the \sphinxcode{\sphinxupquote{\$SINGULARITY\_BIND}} (or
\sphinxcode{\sphinxupquote{\$SINGULARITY\_BINDPATH}}) environment variable. The argument for this option is
a comma-delimited string of bind path specifications in the format
\sphinxcode{\sphinxupquote{src{[}:dest{[}:opts{]}{]}}}, where \sphinxcode{\sphinxupquote{src}} and \sphinxcode{\sphinxupquote{dest}} are paths outside and inside
of the container respectively. If \sphinxcode{\sphinxupquote{dest}} is not given, it is set equal to
\sphinxcode{\sphinxupquote{src}}. Mount options (\sphinxcode{\sphinxupquote{opts}}) may be specified as \sphinxcode{\sphinxupquote{ro}} (read-only) or
\sphinxcode{\sphinxupquote{rw}} (read/write, which is the default). The \sphinxcode{\sphinxupquote{-{-}bind/-B}} option can be
specified multiple times, or a comma-delimited string of bind path
specifications can be used.


\subsection{Specifying bind paths}
\label{\detokenize{bind_paths_and_mounts:specifying-bind-paths}}
Here’s an example of using the \sphinxcode{\sphinxupquote{-{-}bind}} option and binding \sphinxcode{\sphinxupquote{/data}} on the
host to \sphinxcode{\sphinxupquote{/mnt}} in the container (\sphinxcode{\sphinxupquote{/mnt}} does not need to already exist in
the container):

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} ls /data
bar  foo

\PYGZdl{} singularity exec \PYGZhy{}\PYGZhy{}bind /data:/mnt my\PYGZus{}container.sif ls /mnt
bar  foo
\end{sphinxVerbatim}

You can bind multiple directories in a single command with this syntax:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity shell \PYGZhy{}\PYGZhy{}bind /opt,/data:/mnt my\PYGZus{}container.sif
\end{sphinxVerbatim}

This will bind \sphinxcode{\sphinxupquote{/opt}} on the host to \sphinxcode{\sphinxupquote{/opt}} in the container and \sphinxcode{\sphinxupquote{/data}}
on the host to \sphinxcode{\sphinxupquote{/mnt}} in the container.

Using the environment variable instead of the command line argument, this would
be:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} export SINGULARITY\PYGZus{}BIND=\PYGZdq{}/opt,/data:/mnt\PYGZdq{}

\PYGZdl{} singularity shell my\PYGZus{}container.sif
\end{sphinxVerbatim}

Using the environment variable \sphinxcode{\sphinxupquote{\$SINGULARITY\_BIND}}, you can bind paths even
when you are running your container as an executable file with a runscript. If
you bind many directories into your Singularity containers and they don’t
change, you could even benefit by setting this variable in your \sphinxcode{\sphinxupquote{.bashrc}}
file.


\subsection{A note on using \sphinxstyleliteralintitle{\sphinxupquote{-{-}bind}} with the \sphinxstyleliteralintitle{\sphinxupquote{-{-}writable}} flag}
\label{\detokenize{bind_paths_and_mounts:a-note-on-using-bind-with-the-writable-flag}}
To mount a bind path inside the container, a \sphinxstyleemphasis{bind point} must be defined
within the container. The bind point is a directory within the container that
Singularity can use as a destination to bind a directory on the host system.

Starting in version 3.0, Singularity will do its best to bind mount requested
paths into a container regardless of whether the appropriate bind point exists
within the container.  Singularity can often carry out this operation even in
the absence of the “overlay fs” feature.

However, binding paths to non-existent points within the container can result in
unexpected behavior when used in conjuction with the \sphinxcode{\sphinxupquote{-{-}writable}} flag, and is
therefore disallowed. If you need to specify bind paths in combination with the
\sphinxcode{\sphinxupquote{-{-}writable}} flag, please ensure that the appropriate bind points exist within
the container. If they do not already exist, it will be necessary to modify the
container and create them.


\chapter{Persistent Overlays}
\label{\detokenize{persistent_overlays:persistent-overlays}}\label{\detokenize{persistent_overlays::doc}}
Persistent overlay directories allow you to overlay a writable file system on an
immutable read-only container for the illusion of read-write access.


\section{Overview}
\label{\detokenize{persistent_overlays:overview}}
A persistent overlay is a directory that “sits on top” of your compressed,
immutable SIF container. When you install new software or create and modify
files the overlay directory stores the changes.

If you want to use a SIF container as though it were writable, you can create a
directory to use as a persistent overlay. Then you can specify that you want to
use the directory as an overlay at runtime with the \sphinxcode{\sphinxupquote{-{-}overlay}} option.

You can use a persistent overlays with the following commands:
\begin{itemize}
\item {} 
\sphinxcode{\sphinxupquote{run}}

\item {} 
\sphinxcode{\sphinxupquote{exec}}

\item {} 
\sphinxcode{\sphinxupquote{shell}}

\item {} 
\sphinxcode{\sphinxupquote{instance.start}}

\end{itemize}


\section{Usage}
\label{\detokenize{persistent_overlays:usage}}
To use a persistent overlay, you must first have a container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity build ubuntu.sif library://ubuntu
\end{sphinxVerbatim}

Then you must create a directory. (You can also use the \sphinxcode{\sphinxupquote{-{-}overlay}} option
with a legacy writable ext3 image.)

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir my\PYGZus{}overlay
\end{sphinxVerbatim}

Now you can use this overlay directory with your container. Note that it is
necessary to be root to use an overlay directory.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}overlay my\PYGZus{}overlay/ ubuntu.sif

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} touch /foo

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} apt\PYGZhy{}get update \PYGZam{}\PYGZam{} apt\PYGZhy{}get install \PYGZhy{}y vim

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} which vim
/usr/bin/vim

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} exit
\end{sphinxVerbatim}

You will find that your changes persist across sessions as though you were using
a writable container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}overlay my\PYGZus{}overlay/ ubuntu.sif

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} ls /foo
/foo

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} which vim
/usr/bin/vim

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} exit
\end{sphinxVerbatim}

If you mount your container without the \sphinxcode{\sphinxupquote{-{-}overlay}} directory, your changes
will be gone.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell ubuntu.sif

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} ls /foo
ls: cannot access \PYGZsq{}foo\PYGZsq{}: No such file or directory

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} which vim

Singularity ubuntu.sif:\PYGZti{}\PYGZgt{} exit
\end{sphinxVerbatim}


\chapter{Signing and Verifying Containers}
\label{\detokenize{signNverify:signing-and-verifying-containers}}\label{\detokenize{signNverify:signnverify}}\label{\detokenize{signNverify::doc}}\phantomsection\label{\detokenize{signNverify:sec-signnverify}}
Singularity 3.0 introduces the abilities to create and manage PGP keys and use
them to sign and verify containers. This provides a trusted method for
Singularity users to share containers. It ensures a bit-for-bit reproduction
of the original container as the author intended it.


\section{Verifying containers from the Container Library}
\label{\detokenize{signNverify:verifying-containers-from-the-container-library}}
The \sphinxcode{\sphinxupquote{verify}} command will allow you to verify that a container has been
signed using a PGP key. To use this feature with images that you pull from the
container library, you must first generate an access token to the Sylabs Cloud.
If you don’t already have a valid access token, follow these steps:
\begin{enumerate}
\item {} 
Go to : \sphinxurl{https://cloud.sylabs.io/}

\item {} 
Click “Sign in to Sylabs” and follow the sign in steps.

\item {} 
Click on your login id (same and updated button as the Sign in one).

\item {} 
Select “Access Tokens” from the drop down menu.

\item {} 
Click the “Manage my API tokens” button from the “Account Management” page.

\item {} 
Click “Create”.

\item {} 
Click “Copy token to Clipboard” from the “New API Token” page.

\item {} 
Paste the token string into your \sphinxcode{\sphinxupquote{\textasciitilde{}/.singularity/sylabs-token}} file.

\end{enumerate}

Now you can verify containers that you pull from the library, ensuring they are
bit-for-bit reproductions of the original image.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity pull library://alpine

\PYGZdl{} singularity verify alpine\PYGZus{}latest.sif
Verifying image: alpine\PYGZus{}latest.sif
Data integrity checked, authentic and signed by:
    Sylabs Admin \PYGZlt{}support@sylabs.io\PYGZgt{}, KeyID 51BE5020C508C7E9
\end{sphinxVerbatim}

In this example you can see that \sphinxstylestrong{Sylabs Admin} has signed the container.


\section{Signing your own containers}
\label{\detokenize{signNverify:signing-your-own-containers}}

\subsection{Generating and managing PGP keys}
\label{\detokenize{signNverify:generating-and-managing-pgp-keys}}
To sign your own containers you first need to generate one or more keys.

If you attempt to sign a container before you have generated any keys,
Singularity will guide you through the interactive process of creating a new
key. Or you can use the \sphinxcode{\sphinxupquote{newpair}} subcommand in the \sphinxcode{\sphinxupquote{key}} command group
like so:.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity keys newpair
Enter your name (e.g., John Doe) : Dave Godlove
Enter your email address (e.g., john.doe@example.com) : d@sylabs.io
Enter optional comment (e.g., development keys) : demo
Generating Entity and OpenPGP Key Pair... Done
Enter encryption passphrase :
\end{sphinxVerbatim}

The \sphinxcode{\sphinxupquote{list}} subcommand will show you all of the keys you have created or saved
locally.{}`

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity keys list
Public key listing (/home/david/.singularity/sypgp/pgp\PYGZhy{}public):

0) U: Dave Godlove (demo) \PYGZlt{}d@sylabs.io\PYGZgt{}
   C: 2018\PYGZhy{}10\PYGZhy{}08 15:25:30 \PYGZhy{}0400 EDT
   F: 135E426D67D8416DE1D6AC7FFED5BBA38EE0DC4A
   L: 4096
   \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
\end{sphinxVerbatim}

In the output above, the letters stand for the following:
\begin{itemize}
\item {} 
U: User

\item {} 
C: Creation date and time

\item {} 
F: Fingerprint

\item {} 
L: Key length

\end{itemize}

After generating your key you can optionally push it to the \sphinxhref{https://cloud.sylabs.io/keystore}{Keystore}
using the fingerprint like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity keys push 135E426D67D8416DE1D6AC7FFED5BBA38EE0DC4A
public key {}`135E426D67D8416DE1D6AC7FFED5BBA38EE0DC4A{}` pushed to server successfully
\end{sphinxVerbatim}

This will allow others to verify images that you have signed.

If you delete your local public PGP key, you can always locate and download it
again like so.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity keys search Godlove
Search results for \PYGZsq{}Godlove\PYGZsq{}

Type bits/keyID     Date       User ID
\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}
pub  4096R/8EE0DC4A 2018\PYGZhy{}10\PYGZhy{}08 Dave Godlove (demo) \PYGZlt{}d@sylabs.io\PYGZgt{}
\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}

\PYGZdl{} singularity keys pull 8EE0DC4A
1 key(s) fetched and stored in local cache /home/david/.singularity/sypgp/pgp\PYGZhy{}public
\end{sphinxVerbatim}

But note that this only restores the \sphinxstyleemphasis{public} key (used for verifying) to your
local machine and does not restore the \sphinxstyleemphasis{private} key (used for signing).


\subsection{Signing and validating your own containers}
\label{\detokenize{signNverify:signing-and-validating-your-own-containers}}
Now that you have a key generated, you can use it to sign images like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity sign my\PYGZus{}container.sif
Signing image: my\PYGZus{}container.sif
Enter key passphrase:
Signature created and applied to my\PYGZus{}container.sif
\end{sphinxVerbatim}

Because your public PGP key is saved locally you can verify the image without
needing to contact the Keystore.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity verify my\PYGZus{}container.sif
Verifying image: my\PYGZus{}container.sif
Data integrity checked, authentic and signed by:
    Dave Godlove (demo) \PYGZlt{}d@sylabs.io\PYGZgt{}, KeyID FED5BBA38EE0DC4A
\end{sphinxVerbatim}

If you’ve pushed your key to the Keystore you can also verify this image in the
absence of a local key.  To demonstrate this, first delete your local keys, and
then try to use the \sphinxcode{\sphinxupquote{verify}} command again.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} rm \PYGZti{}/.singularity/sypgp/*

\PYGZdl{} singularity verify my\PYGZus{}container.sif
Verifying image: my\PYGZus{}container.sif
INFO:    key missing, searching key server for KeyID: FED5BBA38EE0DC4A...
INFO:    key retreived successfully!
Store new public key 135E426D67D8416DE1D6AC7FFED5BBA38EE0DC4A? [Y/n] y
Data integrity checked, authentic and signed by:
    Dave Godlove (demo) \PYGZlt{}d@sylabs.io\PYGZgt{}, KeyID FED5BBA38EE0DC4A
\end{sphinxVerbatim}

Answering yes at the interactive prompt will store the Public key locally so
you will not have to contact the Keystore again the next time you verify your
container.


\chapter{Security Options}
\label{\detokenize{security_options:security-options}}\label{\detokenize{security_options:id1}}\label{\detokenize{security_options::doc}}\phantomsection\label{\detokenize{security_options:sec-security-options}}
Singularity 3.0 introduces many new security related options to the container
runtime.  This document will describe the new methods users have for specifying
the security scope and context when running Singularity containers.


\section{Linux Capabilities}
\label{\detokenize{security_options:linux-capabilities}}
Singularity provides full support for granting and revoking Linux capabilities
on a user or group basis.  For example, let us suppose that an admin has
decided to grant a user capabilities to open raw sockets so that they can use
\sphinxcode{\sphinxupquote{ping}} in a container where the binary is controlled via capabilities (i.e. a
recent version of CentOS).

To do so, the admin would issue a command such as this:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity capability add \PYGZhy{}\PYGZhy{}user david CAP\PYGZus{}NET\PYGZus{}RAW
\end{sphinxVerbatim}

This means the user \sphinxcode{\sphinxupquote{david}} has just been granted permissions (through Linux
capabilities) to open raw sockets within Singularity containers.

The admin can check that this change is in effect with the \sphinxcode{\sphinxupquote{capability list}}
command.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity capability list \PYGZhy{}\PYGZhy{}user david
CAP\PYGZus{}NET\PYGZus{}RAW
\end{sphinxVerbatim}

To take advantage of this new capability, the user \sphinxcode{\sphinxupquote{david}} must also request
the capability when executing a container with the \sphinxcode{\sphinxupquote{-{-}add-caps}} flag like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} singularity exec \PYGZhy{}\PYGZhy{}add\PYGZhy{}caps CAP\PYGZus{}NET\PYGZus{}RAW library://centos ping \PYGZhy{}c 1 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp\PYGZus{}seq=1 ttl=128 time=18.3 ms

\PYGZhy{}\PYGZhy{}\PYGZhy{} 8.8.8.8 ping statistics \PYGZhy{}\PYGZhy{}\PYGZhy{}
1 packets transmitted, 1 received, 0\PYGZpc{} packet loss, time 0ms
rtt min/avg/max/mdev = 18.320/18.320/18.320/0.000 ms
\end{sphinxVerbatim}

If the admin decides that it is no longer necessary to allow the user \sphinxcode{\sphinxupquote{dave}}
to open raw sockets within Singularity containers, they can revoke the
appropriate Linux capability like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity capability drop \PYGZhy{}\PYGZhy{}user david CAP\PYGZus{}NET\PYGZus{}RAW
\end{sphinxVerbatim}

The \sphinxcode{\sphinxupquote{capabiltiy add}} and \sphinxcode{\sphinxupquote{drop}} subcommands will also accept the case
insensitive keyword \sphinxcode{\sphinxupquote{all}} to grant or revoke all Linux capabilities to a user
or group.  Similarly, the \sphinxcode{\sphinxupquote{-{-}add-caps}} option will accept the \sphinxcode{\sphinxupquote{all}} keyword.
Of course appropriate caution should be exercised when using this keyword.


\section{Security related action options}
\label{\detokenize{security_options:security-related-action-options}}
Singularity 3.0 introduces many new flags that can be passed to the action
commands; \sphinxcode{\sphinxupquote{shell}}, \sphinxcode{\sphinxupquote{exec}}, and \sphinxcode{\sphinxupquote{run}} allowing fine grained control of
security.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}add-caps}}}
\label{\detokenize{security_options:add-caps}}
As explained above, \sphinxcode{\sphinxupquote{-{-}add-caps}} will “activate” Linux capabilities when a
container is initiated, providing those capabilities have been granted to the
user by an administrator using the \sphinxcode{\sphinxupquote{capability add}} command. This option will
also accept the case insensitive keyword \sphinxcode{\sphinxupquote{all}} to add every capability
granted by the administrator.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}allow-setuid}}}
\label{\detokenize{security_options:allow-setuid}}
The SetUID bit allows a program to be executed as the user that owns the binary.
The most well-known SetUID binaries are owned by root and allow a user to
execute a command with elevated privileges.  But other SetUID binaries may
allow a user to execute a command as a service account.

By default SetUID is disallowed within Singularity containers as a security
precaution.  But the root user can override this precaution and allow SetUID
binaries to behave as expected within a Singularity container with the
\sphinxcode{\sphinxupquote{-{-}allow-setuid}} option like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}allow\PYGZhy{}setuid some\PYGZus{}container.sif
\end{sphinxVerbatim}


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}keep-privs}}}
\label{\detokenize{security_options:keep-privs}}
It is possible for an admin to set a different set of default capabilities or to
reduce the default capabilities to zero for the root user by setting the \sphinxcode{\sphinxupquote{root
default capabilities}} parameter in the \sphinxcode{\sphinxupquote{singularity.conf}} file to \sphinxcode{\sphinxupquote{file}} or
\sphinxcode{\sphinxupquote{no}} respectively.  If this change is in effect, the root user can override
the \sphinxcode{\sphinxupquote{singularity.conf}} file and enter the container with full capabilities
using the \sphinxcode{\sphinxupquote{-{-}keep-privs}} option.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}keep\PYGZhy{}privs library://centos ping \PYGZhy{}c 1 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp\PYGZus{}seq=1 ttl=128 time=18.8 ms

\PYGZhy{}\PYGZhy{}\PYGZhy{} 8.8.8.8 ping statistics \PYGZhy{}\PYGZhy{}\PYGZhy{}
1 packets transmitted, 1 received, 0\PYGZpc{} packet loss, time 0ms
rtt min/avg/max/mdev = 18.838/18.838/18.838/0.000 ms
\end{sphinxVerbatim}


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}drop-caps}}}
\label{\detokenize{security_options:drop-caps}}
By default, the root user has a full set of capabilities when they enter the
container. You may choose to drop specific capabilities when you initiate a
container as root to enhance security.

For instance, to drop the ability for the root user to open a raw socket inside
the container:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}drop\PYGZhy{}caps CAP\PYGZus{}NET\PYGZus{}RAW library://centos ping \PYGZhy{}c 1 8.8.8.8
ping: socket: Operation not permitted
\end{sphinxVerbatim}

The \sphinxcode{\sphinxupquote{drop-caps}} option will also accept the case insensitive keyword \sphinxcode{\sphinxupquote{all}}
as an option to drop all capabilities when entering the container.


\subsection{\sphinxstyleliteralintitle{\sphinxupquote{-{-}security}}}
\label{\detokenize{security_options:security}}
The \sphinxcode{\sphinxupquote{-{-}security}} flag allows the root user to leverage security modules such
as SELinux, AppArmor, and seccomp within your Singularity container. You can
also change the UID and GID of the user within the container at runtime.

For instance:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo whoami
root

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}security uid:1000 my\PYGZus{}container.sif whoami
david
\end{sphinxVerbatim}

To use seccomp to blacklist a command follow this procedure. (It is actually
preferable from a security standpoint to whitelist commands but this will
suffice for a simple example.)  Note that this example was run on Ubuntu and
that Singularity was installed with the \sphinxcode{\sphinxupquote{libseccomp-dev}} and \sphinxcode{\sphinxupquote{pkg-config}}
packages as dependencies.

First write a configuration file.  An example configuration file is installed
with Singularity, normally at \sphinxcode{\sphinxupquote{/usr/local/etc/singularity/seccomp-profiles/default.json}}.
For this example, we will use a much simpler configuration file to blacklist the
\sphinxcode{\sphinxupquote{mkdir}} command.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZob{}
    \PYGZdq{}defaultAction\PYGZdq{}: \PYGZdq{}SCMP\PYGZus{}ACT\PYGZus{}ALLOW\PYGZdq{},
    \PYGZdq{}archMap\PYGZdq{}: [
        \PYGZob{}
            \PYGZdq{}architecture\PYGZdq{}: \PYGZdq{}SCMP\PYGZus{}ARCH\PYGZus{}X86\PYGZus{}64\PYGZdq{},
            \PYGZdq{}subArchitectures\PYGZdq{}: [
                \PYGZdq{}SCMP\PYGZus{}ARCH\PYGZus{}X86\PYGZdq{},
                \PYGZdq{}SCMP\PYGZus{}ARCH\PYGZus{}X32\PYGZdq{}
            ]
        \PYGZcb{}
    ],
    \PYGZdq{}syscalls\PYGZdq{}: [
        \PYGZob{}
            \PYGZdq{}names\PYGZdq{}: [
                \PYGZdq{}mkdir\PYGZdq{}
            ],
            \PYGZdq{}action\PYGZdq{}: \PYGZdq{}SCMP\PYGZus{}ACT\PYGZus{}KILL\PYGZdq{},
            \PYGZdq{}args\PYGZdq{}: [],
            \PYGZdq{}comment\PYGZdq{}: \PYGZdq{}\PYGZdq{},
            \PYGZdq{}includes\PYGZdq{}: \PYGZob{}\PYGZcb{},
            \PYGZdq{}excludes\PYGZdq{}: \PYGZob{}\PYGZcb{}
        \PYGZcb{}
    ]
\PYGZcb{}
\end{sphinxVerbatim}

We’ll save the file at \sphinxcode{\sphinxupquote{/home/david/no\_mkdir.json}}. Then we can invoke the
container like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}security seccomp:/home/david/no\PYGZus{}mkdir.json my\PYGZus{}container.sif

Singularity\PYGZgt{} mkdir /tmp/foo
Bad system call (core dumped)
\end{sphinxVerbatim}

Note that attempting to use the blacklisted \sphinxcode{\sphinxupquote{mkdir}} command resulted in a
core dump.

The full list of arguments accepted by the \sphinxcode{\sphinxupquote{-{-}security}} option are as follows:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}seccomp:/usr/local/etc/singularity/seccomp\PYGZhy{}profiles/default.json\PYGZdq{}
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}apparmor:/usr/bin/man\PYGZdq{}
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}selinux:context\PYGZdq{}
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}uid:1000\PYGZdq{}
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}gid:1000\PYGZdq{}
\PYGZhy{}\PYGZhy{}security=\PYGZdq{}gid:1000:1:0\PYGZdq{} (multiple gids, first is always the primary group)
\end{sphinxVerbatim}


\chapter{Network virtualization}
\label{\detokenize{networking:network-virtualization}}\label{\detokenize{networking:networking}}\label{\detokenize{networking::doc}}\phantomsection\label{\detokenize{networking:sec-networking}}
Singularity 3.0 introduces full integration with
\sphinxhref{https://github.com/containernetworking/cni}{cni} , and several new features to
make network virtualization easy.

A few new options have been added to the action commands (\sphinxcode{\sphinxupquote{exec}}, \sphinxcode{\sphinxupquote{run}},
and \sphinxcode{\sphinxupquote{shell}}) to facilitate these features, and the \sphinxcode{\sphinxupquote{-{-}net}} option has been
updated as well.  These options can only be used by root.


\section{\sphinxstyleliteralintitle{\sphinxupquote{-{-}dns}}}
\label{\detokenize{networking:dns}}
The \sphinxcode{\sphinxupquote{-{-}dns}} option allows you to specify a comma separated list of DNS servers
to add to the \sphinxcode{\sphinxupquote{/etc/resolv.conf}} file.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} nslookup sylabs.io \textbar{} grep Server
Server:             127.0.0.53

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}dns 8.8.8.8 ubuntu.sif nslookup sylabs.io \textbar{} grep Server
Server:             8.8.8.8

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}dns 8.8.8.8 ubuntu.sif cat /etc/resolv.conf
nameserver 8.8.8.8
\end{sphinxVerbatim}


\section{\sphinxstyleliteralintitle{\sphinxupquote{-{-}hostname}}}
\label{\detokenize{networking:hostname}}
The \sphinxcode{\sphinxupquote{-{-}hostname}} option accepts a string argument to change the hostname
within the container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} hostname
ubuntu\PYGZhy{}bionic

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}hostname hal\PYGZhy{}9000 my\PYGZus{}container.sif hostname
hal\PYGZhy{}9000
\end{sphinxVerbatim}


\section{\sphinxstyleliteralintitle{\sphinxupquote{-{-}net}}}
\label{\detokenize{networking:net}}
Passing the \sphinxcode{\sphinxupquote{-{-}net}} flag will cause the container to join a new network
namespace when it initiates.  New in Singularity 3.0, a bridge interface will
also be set up by default.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} hostname \PYGZhy{}I
10.0.2.15

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}net my\PYGZus{}container.sif hostname \PYGZhy{}I
10.22.0.4
\end{sphinxVerbatim}


\section{\sphinxstyleliteralintitle{\sphinxupquote{-{-}network}}}
\label{\detokenize{networking:network}}
The \sphinxcode{\sphinxupquote{-{-}network}} option can only be invoked in combination with the \sphinxcode{\sphinxupquote{-{-}net}}
flag.  It accepts a comma delimited string of network types. Each entry will
bring up a dedicated interface inside container.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} hostname \PYGZhy{}I
172.16.107.251 10.22.0.1

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}net \PYGZhy{}\PYGZhy{}network ptp ubuntu.sif hostname \PYGZhy{}I
10.23.0.6

\PYGZdl{} sudo singularity exec \PYGZhy{}\PYGZhy{}net \PYGZhy{}\PYGZhy{}network bridge,ptp ubuntu.sif hostname \PYGZhy{}I
10.22.0.14 10.23.0.7
\end{sphinxVerbatim}

When invoked, the \sphinxcode{\sphinxupquote{-{-}network}} option searches the singularity configuration
directory (commonly \sphinxcode{\sphinxupquote{/usr/local/etc/singularity/network/}}) for the cni
configuration file corresponding to the requested network type(s). Several
configuration files are installed with Singularity by default corresponding to
the following network types:
\begin{itemize}
\item {} 
bridge

\item {} 
ptp

\item {} 
ipvlan

\item {} 
macvlan

\end{itemize}

Administrators can also define custom network configurations and place them in
the same directory for the benefit of users.


\section{\sphinxstyleliteralintitle{\sphinxupquote{-{-}network-args}}}
\label{\detokenize{networking:network-args}}
The \sphinxcode{\sphinxupquote{-{-}network-args}} option provides a convenient way to specify arguments to
pass directly to the cni plugins.  It must be used in conjuction with the
\sphinxcode{\sphinxupquote{-{-}net}} flag.

For instance, let’s say you want to start an \sphinxhref{https://www.nginx.com/}{NGINX}
server on port 80 inside of the container, but you want to map it to port 8080
outside of the container:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity instance start \PYGZhy{}\PYGZhy{}writable\PYGZhy{}tmpfs \PYGZbs{}
    \PYGZhy{}\PYGZhy{}net \PYGZhy{}\PYGZhy{}network\PYGZhy{}args \PYGZdq{}portmap=8080:80/tcp\PYGZdq{} docker://nginx web2
\end{sphinxVerbatim}

The above command will start the Docker Hub official NGINX image running in a
background instance called \sphinxcode{\sphinxupquote{web2}}.  The NGINX instance will need to be able to
write to disk, so we’ve used the \sphinxcode{\sphinxupquote{-{-}writable-tmpfs}} argument to allocate some
space in memory.  The \sphinxcode{\sphinxupquote{-{-}net}} flag is necessary when using the
\sphinxcode{\sphinxupquote{-{-}network-args}} option, and specifying the \sphinxcode{\sphinxupquote{portmap=8080:80/tcp}} argument
which will map port 80 inside of the container to 8080 on the host.

Now we can start NGINX inside of the container:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity exec instance://web2 nginx
\end{sphinxVerbatim}

And the \sphinxcode{\sphinxupquote{curl}} command can be used to verify that NGINX is running on the host
port 8080 as expected.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} curl localhost:8080
10.22.0.1 \PYGZhy{} \PYGZhy{} [16/Oct/2018:09:34:25 \PYGZhy{}0400] \PYGZdq{}GET / HTTP/1.1\PYGZdq{} 200 612 \PYGZdq{}\PYGZhy{}\PYGZdq{} \PYGZdq{}curl/7.58.0\PYGZdq{} \PYGZdq{}\PYGZhy{}\PYGZdq{}
\PYGZlt{}!DOCTYPE html\PYGZgt{}
\PYGZlt{}html\PYGZgt{}
\PYGZlt{}head\PYGZgt{}
\PYGZlt{}title\PYGZgt{}Welcome to nginx!\PYGZlt{}/title\PYGZgt{}
\PYGZlt{}style\PYGZgt{}
    body \PYGZob{}
        width: 35em;
        margin: 0 auto;
        font\PYGZhy{}family: Tahoma, Verdana, Arial, sans\PYGZhy{}serif;
    \PYGZcb{}
\PYGZlt{}/style\PYGZgt{}
\PYGZlt{}/head\PYGZgt{}
\PYGZlt{}body\PYGZgt{}
\PYGZlt{}h1\PYGZgt{}Welcome to nginx!\PYGZlt{}/h1\PYGZgt{}
\PYGZlt{}p\PYGZgt{}If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.\PYGZlt{}/p\PYGZgt{}

\PYGZlt{}p\PYGZgt{}For online documentation and support please refer to
\PYGZlt{}a href=\PYGZdq{}http://nginx.org/\PYGZdq{}\PYGZgt{}nginx.org\PYGZlt{}/a\PYGZgt{}.\PYGZlt{}br/\PYGZgt{}
Commercial support is available at
\PYGZlt{}a href=\PYGZdq{}http://nginx.com/\PYGZdq{}\PYGZgt{}nginx.com\PYGZlt{}/a\PYGZgt{}.\PYGZlt{}/p\PYGZgt{}

\PYGZlt{}p\PYGZgt{}\PYGZlt{}em\PYGZgt{}Thank you for using nginx.\PYGZlt{}/em\PYGZgt{}\PYGZlt{}/p\PYGZgt{}
\PYGZlt{}/body\PYGZgt{}
\PYGZlt{}/html\PYGZgt{}
\end{sphinxVerbatim}

For more information about cni, check the
\sphinxhref{https://github.com/containernetworking/cni/blob/master/SPEC.md}{cni specification}.


\chapter{Limiting container resources with cgroups}
\label{\detokenize{cgroups:limiting-container-resources-with-cgroups}}\label{\detokenize{cgroups:cgroups}}\label{\detokenize{cgroups::doc}}
Starting in Singularity 3.0, users have the ability to limit container resources
using cgroups.


\section{Overview}
\label{\detokenize{cgroups:overview}}
Singularity cgroups support can be configured and utilized via a TOML file. An
example file is typically installed at
\sphinxcode{\sphinxupquote{/usr/local/etc/singularity/cgroups/cgroups.toml}}.  You can copy and edit this
file to suit your needs.  Then when you need to limit your container resources,
apply the settings in the TOML file by using the path as an argument to the
\sphinxcode{\sphinxupquote{-{-}apply-cgroups}} option like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity shell \PYGZhy{}\PYGZhy{}apply\PYGZhy{}cgroups /path/to/cgroups.toml my\PYGZus{}container.sif
\end{sphinxVerbatim}

The \sphinxcode{\sphinxupquote{-{-}apply-cgroups}} option can only be used with root privileges.


\section{Examples}
\label{\detokenize{cgroups:examples}}

\subsection{Limiting memory}
\label{\detokenize{cgroups:limiting-memory}}
To limit the amount of memory that your container uses to 500MB (524288000
bytes), follow this example.  First, create a \sphinxcode{\sphinxupquote{cgroups.toml}} file like this
and save it in your home directory.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[memory]
    limit = 524288000
\end{sphinxVerbatim}

Start your container like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity instance start \PYGZhy{}\PYGZhy{}apply\PYGZhy{}cgroups /home/\PYGZdl{}USER/cgroups.toml \PYGZbs{}
    my\PYGZus{}container.sif instance1
\end{sphinxVerbatim}

After that, you can verify that the container is only using 500MB of memory.
(This example assumes that \sphinxcode{\sphinxupquote{instance1}} is the only running instance.)

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cat /sys/fs/cgroup/memory/singularity/*/memory.limit\PYGZus{}in\PYGZus{}bytes
524288000
\end{sphinxVerbatim}

After you are finished with this example, be sure to cleanup your instance with
the following command.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} sudo singularity instance stop instance1
\end{sphinxVerbatim}

Similarly, the remaining examples can be tested by starting instances and
examining the contents of the appropriate subdirectories of \sphinxcode{\sphinxupquote{/sys/fs/cgroup/}}.


\subsection{Limiting CPU}
\label{\detokenize{cgroups:limiting-cpu}}
Limit CPU resources using one of the following strategies. The \sphinxcode{\sphinxupquote{cpu}} section
of the configuration file can limit memory with the following:


\subsubsection{shares}
\label{\detokenize{cgroups:shares}}
This corresponds to a ratio versus other cgroups with cpu shares. Usually the
default value is \sphinxcode{\sphinxupquote{1024}}. That means if you want to allow to use 50\% of a
single CPU, you will set \sphinxcode{\sphinxupquote{512}} as value.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[cpu]
    shares = 512
\end{sphinxVerbatim}

A cgroup can get more than its share of CPU if there are enough idle CPU cycles
available in the system, due to the work conserving nature of the scheduler, so
a contained process can consume all CPU cycles even with a ratio of 50\%. The
ratio is only applied when two or more processes conflicts with their needs of
CPU cycles.


\subsubsection{quota/period}
\label{\detokenize{cgroups:quota-period}}
You can enforce hard limits on the CPU cycles a cgroup can consume, so
contained processes can’t use more than the amount of CPU time set for the
cgroup. \sphinxcode{\sphinxupquote{quota}} allows you to configure the amount of CPU time that a cgroup
can use per period. The default is 100ms (100000us). So if you want to limit
amount of CPU time to 20ms during period of 100ms:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[cpu]
    period = 100000
    quota = 20000
\end{sphinxVerbatim}


\subsubsection{cpus/mems}
\label{\detokenize{cgroups:cpus-mems}}
You can also restrict access to specific CPUs and associated memory nodes by
using \sphinxcode{\sphinxupquote{cpus/mems}} fields:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[cpu]
    cpus = \PYGZdq{}0\PYGZhy{}1\PYGZdq{}
    mems = \PYGZdq{}0\PYGZhy{}1\PYGZdq{}
\end{sphinxVerbatim}

Where container has limited access to CPU 0 and CPU 1.

\begin{sphinxadmonition}{note}{Note:}
It’s important to set identical values for both \sphinxcode{\sphinxupquote{cpus}} and \sphinxcode{\sphinxupquote{mems}}.
\end{sphinxadmonition}

For more information about limiting CPU with cgroups, see the following external
links:
\begin{itemize}
\item {} 
\sphinxhref{https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/6/html/resource\_management\_guide/sec-cpu/}{Red Hat resource management guide section 3.2 CPU}

\item {} 
\sphinxhref{https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/6/html/resource\_management\_guide/sec-cpuset}{Red Hat resource management guide section 3.4 CPUSET}

\item {} 
\sphinxhref{https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt}{Kernel scheduler documentation}

\end{itemize}


\subsection{Limiting IO}
\label{\detokenize{cgroups:limiting-io}}
You can limit and monitor access to I/O for block devices.  Use the
\sphinxcode{\sphinxupquote{{[}blockIO{]}}} section of the configuration file to do this like so:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[blockIO]
    weight = 1000
    leafWeight = 1000
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{weight}} and \sphinxcode{\sphinxupquote{leafWeight}} accept values between \sphinxcode{\sphinxupquote{10}} and \sphinxcode{\sphinxupquote{1000}}.

\sphinxcode{\sphinxupquote{weight}} is the default weight of the group on all the devices until and
unless overridden by a per device rule.

\sphinxcode{\sphinxupquote{leafWeight}} relates to weight for the purpose of deciding how heavily to
weigh tasks in the given cgroup while competing with the cgroup’s child cgroups.

To override \sphinxcode{\sphinxupquote{weight/leafWeight}} for \sphinxcode{\sphinxupquote{/dev/loop0}} and \sphinxcode{\sphinxupquote{/dev/loop1}} block
devices you would do something like this:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[blockIO]
    [[blockIO.weightDevice]]
        major = 7
        minor = 0
        weight = 100
        leafWeight = 50
    [[blockIO.weightDevice]]
        major = 7
        minor = 1
        weight = 100
        leafWeight = 50
\end{sphinxVerbatim}

You could limit the IO read/write rate to 16MB per second for the \sphinxcode{\sphinxupquote{/dev/loop0}}
block device with the following configuration.  The rate is specified in bytes
per second.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[blockIO]
    [[blockIO.throttleReadBpsDevice]]
        major = 7
        minor = 0
        rate = 16777216
    [[blockIO.throttleWriteBpsDevice]]
        major = 7
        minor = 0
        rate = 16777216
\end{sphinxVerbatim}

To limit the IO read/write rate to 1000 IO per second (IOPS) on \sphinxcode{\sphinxupquote{/dev/loop0}}
block device, you can do the following. The rate is specified in IOPS.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[blockIO]
    [[blockIO.throttleReadIOPSDevice]]
        major = 7
        minor = 0
        rate = 1000
    [[blockIO.throttleWriteIOPSDevice]]
        major = 7
        minor = 0
        rate = 1000
\end{sphinxVerbatim}

For more information about limiting IO, see the following external links:
\begin{itemize}
\item {} 
\sphinxhref{https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/6/html/resource\_management\_guide/ch-subsystems\_and\_tunable\_parameters\#sec-blkio}{Red Hat resource management guide section 3.1 blkio}

\item {} 
\sphinxhref{https://www.kernel.org/doc/Documentation/cgroup-v1/blkio-controller.txt}{Kernel block IO controller documentation}

\item {} 
\sphinxhref{https://www.kernel.org/doc/Documentation/block/cfq-iosched.txt}{Kernel CFQ scheduler documentation}

\end{itemize}


\subsubsection{Limiting device access}
\label{\detokenize{cgroups:limiting-device-access}}
You can limit read, write, or creation of devices. In this example, a container
is configured to only be able to read from or write to \sphinxcode{\sphinxupquote{/dev/null}}.

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
[[devices]]
    access = \PYGZdq{}rwm\PYGZdq{}
    allow = false
[[devices]]
    access = \PYGZdq{}rw\PYGZdq{}
    allow = true
    major = 1
    minor = 3
    type = \PYGZdq{}c\PYGZdq{}
\end{sphinxVerbatim}

For more information on limiting access to devices the \sphinxhref{https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/6/html/resource\_management\_guide/sec-devices}{Red Hat resource
management guide section 3.5 DEVICES}.



\renewcommand{\indexname}{Index}
\printindex
\end{document}